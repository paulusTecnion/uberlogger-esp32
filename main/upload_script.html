<table class="fixed" border="0">
  <col width="1000px" />
  <col width="500px" />
  <tr>
    <td>
      <h2>Uberlogger Firmware upgrade</h2>
    </td>
  </tr>
  <tr>
    <td>
      <h4>
        Make sure you have an SD card inserted! Do not power-toggle the device
        while flashing!!
      </h4>
    </td>
  </tr>
  <tr>
    <td>
      <form id="file-upload-form">
        <table border="0">
          <tr>
            <td>
              <label for="ota_main">File ota_main.bin</label>
            </td>
            <td colspan="2">
              <input
                id="ota_main"
                type="file"
                accept=".bin"
                value="ota_main.bin"
                onchange="setpath()"
                style="width: 100%"
              />
            </td>
          </tr>
          <tr>
            <td>
              <label for="mainbinlabel">ota_main.bin path</label>
            </td>
            <td>
              <input id="filepath_ota_main" type="text" style="width: 100%" />
            </td>
          </tr>

          <tr>
            <td>
              <label for="ota_support">File ota_support.bin</label>
            </td>
            <td colspan="2">
              <input
                id="ota_support"
                type="file"
                accept=".bin"
                value="ota_support.bin"
                onchange="setpath()"
                style="width: 100%"
              />
            </td>
          </tr>

          <tr>
            <td>
              <label for="supportlabel">ota_support.bin path</label>
            </td>
            <td>
              <input
                id="filepath_ota_support"
                type="text"
                style="width: 100%"
              />
            </td>
          </tr>

          <tr>
            <td>
              <label for="ota_filesystem">File ota_filesystem.bin</label>
            </td>
            <td colspan="2">
              <input
                id="ota_filesystem"
                type="file"
                accept=".bin"
                value="ota_filesystem"
                onchange="setpath()"
                style="width: 100%"
              />
            </td>
          </tr>

          <tr>
            <td>
              <label for="filesystemlabel">ota_filesystem.bin path</label>
            </td>
            <td>
              <input
                id="filepath_ota_filesystem"
                type="text"
                style="width: 100%"
              />
            </td>
          </tr>
          <tr>
            <td>
              <button id="upload" type="submit">Upload & update</button>
            </td>
          </tr>
        </table>
      </form>
    </td>
  </tr>
</table>
<div id="fw-update-state">
  <label for="update-progress" id="update-progress-label"></label>
  <progress
    id="update-progress"
    value="0"
    max="3"
    style="width: 250px"
  ></progress>
</div>
<div id="status-text"></div>
<script>
  function setpath() {
    var default_path = document.getElementById("ota_main").files[0].name;
    document.getElementById("filepath_ota_main").value = default_path;

    default_path = document.getElementById("ota_support").files[0].name;
    document.getElementById("filepath_ota_support").value = default_path;

    default_path = document.getElementById("ota_filesystem").files[0].name;
    document.getElementById("filepath_ota_filesystem").value = default_path;
  }

  async function upload(file, upload_path) {
    return new Promise((resolve, reject) => {
      const xhttp = new XMLHttpRequest();

      xhttp.onreadystatechange = function () {
        if (xhttp.readyState === 4) {
          if (xhttp.status === 200 || xhttp.status === 0) {
            resolve(xhttp.responseText);
            // return;
          } else if (xhttp.status >= 400) {
            reject(xhttp.responseText);
            // return xhttp.responseText;
          }
        }
      };
      xhttp.open("POST", upload_path, true);
      xhttp.setRequestHeader("Content-Type", "multipart/form-data");
      xhttp.send(file);
    });
  }

  async function uploadFiles(files, upload_path, myDiv) {
    try {
      for (let i = 0; i < 3; i++) {
        if (files[i]) {
          // myDiv.innerHTML += "<p>Uploading file " + (i + 1) + " of 3...</p>";
          myDiv.value = i + 1;
          const resultMsg = await upload(files[i], upload_path[i]);
        }
      }

      return true;
    } catch (err) {
      alert(
        "Upload failed: " +
          err +
          ". Please press the reset button of the Uberlogger and try again."
      );
      return false;
    }
  }

  async function enableFWupdate() {
    try {
      const response = await fetch("/fwupdate/enable");

      if (response.status === 200) {
        return 0;
      } else {
        return 1;
      }
    } catch (error) {
      console.error("An error occurred:", error) +
        ". Please press the reset button of the Uberlogger and try again.";
      return 1;
    }
  }

  function disableAllElements() {
    document.getElementById("ota_main").disabled = true;
    document.getElementById("filepath_ota_main").disabled = true;
    document.getElementById("ota_support").disabled = true;
    document.getElementById("filepath_ota_support").disabled = true;
    document.getElementById("ota_filesystem").disabled = true;
    document.getElementById("filepath_ota_filesystem").disabled = true;
    document.getElementById("upload").disabled = true;
  }

  function processNumber(number) {
    switch (number) {
      case 0:
        document.getElementById("fw-update-state").innerHTML += "<p>Idle</p>";

        break;

      case 1:
        document.getElementById("fw-update-state").innerHTML =
          "<p>Flashing support chip</p>";
        break;

      case 2:
        document.getElementById("fw-update-state").innerHTML =
          "<p>Flashing data</p>";
        break;

      case 3:
        document.getElementById("fw-update-state").innerHTML =
          "<p>Flashing main chip</p>";
        break;

      case 4:
        document.getElementById("fw-update-state").innerHTML =
          "<p>Update complete, rebooting...</p>";
        break;

      case 5:
        document.getElementById("fw-update-state").innerHTML =
          "<p>Update failed</p>";
        break;
    }
  }

  async function doWork(files, upload_path, myDiv) {
    try {
      document.getElementById("update-progress-label").innerText =
        "Uploading files...";
      const result = await uploadFiles(files, upload_path, myDiv);
      if (!result) {
        document.getElementById("fw-update-state").innerText =
          "Failed to upload files! Please reset the logger, empty the SD card on your pc and try again.";
        return false;
      }

      // Start the FW update process
      try {
        document.getElementById("update-progress-label").innerText =
          "Upload complete!";

        document.getElementById("status-text").innerHTML =
          'Updating firmware..please wait until green led is lighting up continuously again and reconnect to the Uberlogger (if necessary). Updating will take around 60 seconds. After that go back to the <a href="/">start page</a>. If the green LED does start blinking, reset the logger and try again or contact customer support.';
        result2 = await fetch("/fwupdate/startupgrade");
      } catch (result2) {
        document.getElementById("fw-update-state").innerHTML = "";
        return false;
      }

      // wait for 60 seconds
      // var countdown = 60;
      // var timer = setInterval(function () {
      //   countdown--;
      //   if (countdown <= 0) {
      //     clearInterval(timer);
      //     document.getElementById("update-progress-label").innerText =
      //       "Done! Forwarding... Make sure you are connected to the same Wi-Fi as the Uberlogger";
      //     return;
      //   }

      //   if (countdown < 10) {
      //     document.getElementById("update-progress-label").innerText =
      //       "Waiting for Uberlogger to finish flashing... " +
      //       countdown +
      //       " seconds left. Almost...";
      //   } else {
      //     document.getElementById("update-progress-label").innerText =
      //       "Waiting for Uberlogger to finish flashing... " +
      //       countdown +
      //       " seconds left";
      //   }
      // }, 1000);
      // console.log("Trying to connect");

      // Keep polling for state of FW updater
      // const intervalId = setInterval(() => {
      //   fetch("/fwupdate/state")
      //     .then((response) => response.json())
      //     .then((data) => {
      //       // processNumber(data);
      //       // if (data === 0) {
      //       clearInterval(intervalId);
      //       // Wait for 3 seconds before forwarding to main page
      //       setTimeout(() => {
      //         window.location.href = "/";
      //       }, 3000);
      //       // }
      //     })
      //     .catch((error) => console.error("Error:", error));
      // }, 1000);
    } catch (err) {
      alert("Firmware update failed: " + err);
      return false;
    }
  }

  const form = document.getElementById("file-upload-form");

  form.addEventListener("submit", async function (e) {
    e.preventDefault();
    let localtest = false;

    if (
      !confirm(
        "You are about to flash your Uberlogger. Do not interrupt this process, since this may brick your Uberlogger! Continue?"
      )
    ) {
      // If user cancels, re-enable the inputs and return
      for (let input of inputs) {
        input.disabled = false;
      }
      return;
    }

    // disableAllElements();

    let inputs = document.querySelectorAll("input, button");
    for (let input of inputs) {
      input.disabled = true;
    }
    var lastResponseLength = 0;

    // var myDiv = document.getElementById("fw-update-state");
    var myDiv = document.getElementById("update-progress");
    myDiv.innerHTML = "";
    // myDiv.innerHTML += "<p>Uploading files...</p>";

    let files = [];
    let upload_path = [];
    var filePath = [];
    var fileInput = [];

    // Check file names
    const expectedNames = [
      "ota_main.bin",
      "ota_support.bin",
      "ota_filesystem.bin",
    ];
    const fileIds = ["ota_main", "ota_support", "ota_filesystem"];
    for (let i = 0; i < fileIds.length; i++) {
      const fileElem = document.getElementById(fileIds[i]);
      if (!fileElem.files.length) {
        alert(`Please select the ${expectedNames[i]} file.`);
        for (let input of inputs) {
          input.disabled = false; // Re-enable the inputs
        }
        return;
      } else if (fileElem.files[0].name !== expectedNames[i]) {
        alert(
          `The selected file for ${fileIds[i]} does not match the expected file name: ${expectedNames[i]}.`
        );
        for (let input of inputs) {
          input.disabled = false; // Re-enable the inputs
        }
        return;
      }
    }

    const result = await enableFWupdate();
    if (result) {
      return;
    }

    for (i = 0; i < 3; i++) {
      switch (i) {
        case 0:
          filePath[i] = document.getElementById("filepath_ota_main").value;
          fileInput[i] = document.getElementById("ota_main").files;
          break;
        case 1:
          filePath[i] = document.getElementById("filepath_ota_support").value;
          fileInput[i] = document.getElementById("ota_support").files;
          break;
        case 2:
          filePath[i] = document.getElementById(
            "filepath_ota_filesystem"
          ).value;
          fileInput[i] = document.getElementById("ota_filesystem").files;
          break;
      }

      if (localtest) {
        upload_prefix = "http://192.168.4.1";
      } else {
        upload_prefix = "";
      }

      upload_path[i] = upload_prefix + "/upload/" + filePath[i];

      /* Get the file input element. */
      switch (i) {
        case 0:
          fileInput[i] = document.getElementById("ota_main").files;
          break;
        case 1:
          fileInput[i] = document.getElementById("ota_support").files;
          break;
        case 2:
          fileInput[i] = document.getElementById("ota_filesystem").files;
          break;
      }

      /* Max size of an individual file. Make sure this
       * value is same as that set in file_server.c */
      var MAX_FILE_SIZE = 1000 * 1024;
      var MAX_FILE_SIZE_STR = "1MB";

      if (fileInput[i].length == 0) {
        alert("No file selected!");
        return;
      } else if (filePath[i].length == 0) {
        alert("File path on server is not set!");
        return;
      } else if (filePath[i].indexOf(" ") >= 0) {
        alert("File path on server cannot have spaces!");
        return;
      } else if (filePath[i][filePath[i].length - 1] == "/") {
        alert("File name not specified after path!");
        return;
      } else if (fileInput[i][0].size > MAX_FILE_SIZE) {
        alert("File size must be less than 1MB!");
        return;
      }

      files[i] = fileInput[i][0];
    }

    // Upload files
    doWork(files, upload_path, myDiv);
  });
</script>
