image: espressif/idf:v5.0.1

stages:
  - update_version
  - build
  - create_release

update_version:
  stage: update_version
  only:
    - master
  script:
    - sed -i '/MINOR = /s/\(MINOR = \)\([0-9]\+\)/echo "\1$((\2 + 1))"/e' update_version.py

build_code:
  stage: build
  script:
    - sed -i '/CONFIG_ESP_CONSOLE_USB_CDC=y/d' sdkconfig
    - sed -i '/CONFIG_ESP_CONSOLE_USB_CDC_RX_BUF_SIZE=64/d' sdkconfig
    - idf.py build
    - |
      VERSION=$(grep 'static const char SW_VERSION\[\]' main/sysinfo.h | awk -F '"' '{print $2}' | awk -F '_' '{print $1}')
      if [ "$CI_COMMIT_REF_NAME" != "master" ]; then
          VERSION="dirty_${VERSION}"
      fi
      echo "VERSION=${VERSION}" >> build_vars
    - mv build/uberlogger-esp32.bin build/ota_main.bin
    - mv build/www.bin build/ota_filesystem.bin
  artifacts:
    name: ${VERSION}
    paths:
      - build/ota_main.bin
      - build/ota_filesystem.bin
      - build_vars

create_release:
  stage: create_release
  script:
    - source build_vars
    # Enable pushing from CI pipeline:
    #
    # At that point git origin points to CI_REPOSITORY_URL=
    # https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/acme/my-project.git
    # This setup does not allow modifications (i.e git push will be rejected).
    #
    # Setting SSH environment is what many developers do to execute git commands here,
    # but it is complex and requires submitting SSH private keys to Gitlab (cringe).
    #
    # Private Gitlab tokens are deprecated.
    #
    # We use Gitlab Personal Access Token with 'write' access. This token shall
    # be generated via Gitlab user settings and then it shall be added as a masked
    # environment variable for this project CI settings.
    #
    # Use "oauth2" as user. For example for CI_PROJECT_URL=https://gitlab.com/acme/my-project
    #   set origin to https://oauth2:wSHnMvSmYXtTfXtqRMxs@gitlab.com/acme/my-project.git
    #
    - git remote set-url origin ${CI_PROJECT_URL/gitlab.com/oauth2:${GITLAB_PRIVATE_TOKEN}@gitlab.com}.git
    - git remote -v

    # Don't trigger pipeline again:
    # -o ci.skip is not well known Gitlab Git option which allows skipping new CI.
    # Without ci.skip option CI would be triggered recursively by tag push.
    #
    # - git push origin v1.9d --force -o ci.skip
    - git tag $VERSION
    - git push -o ci.skip
    - ARTIFACT_LINK="https://gitlab.com/uberlogger/uberlogger-esp32/-/jobs/artifacts/${VERSION}/download?job=create_artifact_zip"
    - |
      curl --header "PRIVATE-TOKEN: ${GITLAB_PRIVATE_TOKEN}" -X POST "https://gitlab.com/api/v4/projects/39465634/releases" \
      -d "name=$VERSION" \
      -d "tag_name=$VERSION" \
      -d "description=Release version $VERSION" \
      -d "assets[links][][name]=Artifacts" \
      -d "assets[links][][url]=$ARTIFACT_LINK"
  dependencies:
    - build_code
  only:
    - master
